

> **Contexto:** O projeto já roda com **FastAPI** + **Jinja2** + Tailwind, middlewares de segurança, rate limit, limpeza de temporários e UI base (nav/footer/hero/dash/about/contact/privacy/terms). As rotas são montadas em `main.py` com routers `auth`, `tools`, `billing`, `admin`, além do router principal. Há *cleanup* periódico em `/tmp` e o **CSRF middleware está comentado**.&#x20;
> A camada de UI usa **Tailwind**, **HTMX**, **Alpine**, **Lucide** e helpers `t()` para i18n nos templates `base.html`, `index.html`, `dashboard.html`, `about.html`, `contact.html`, `privacy.html`, `terms.html`.      &#x20;

---

## OBJETIVO

Consertar e evoluir o **HubPDF** para um serviço estável de **conversão/edição de PDF** com:

* PDF ↔ DOCX/XLSX/PPTX
* PDF ↔ imagens (ICO/PNG/JPG/JPEG)
* PDF → TXT (extração de texto, com fallback OCR)
* Dividir PDF por páginas/intervalos
* Compactar/otimizar PDF
* Extrair texto e gerar **novo PDF somente-texto** (quando pedido)

**Requisitos transversais:** manter segurança (CSRF/JWT/headers), rate limit, quotas, limpeza de temporários, UX simples e responsiva, e mensagens de erro padronizadas.

---

## TAREFAS (priorize na ordem)

### 1) Acertos imediatos e hardening

* **Reativar CSRF**: reabilitar `CSRFMiddleware` (está comentado) e garantir que requisições `POST` enviem o header `X-CSRF-Token` já previsto no `<meta name="csrf-token">` e no hook de HTMX. &#x20;
* **TrustedHost/CORS**: em prod, confirme `TrustedHostMiddleware` ativo com domínios reais; em dev, manter `DEBUG` para `reload` e logs.&#x20;
* **Limpeza de temporários**: manter `periodic_cleanup()` (10 min) e parametrizar TTL por settings; não apagar diretórios ativos (usar “lock file” durante jobs).&#x20;
* **Ícones na UI**: padronizar em **Lucide**. O `contact.html` usa `data-feather` (Feather), troque para `data-lucide` para evitar ícones “sumidos”. &#x20;
* **I18n/Strings**: garantir que todas as chaves chamadas pelos templates existem (ex.: `nav_*`, `privacy_*`, `terms_*`, `footer_*`). Templates dependem de `t()`.  &#x20;

### 2) Camada de serviço de conversão

Crie `app/services/conversion.py` com API clara e idempotente:

```python
class ConversionService:
    def pdf_to_docx(self, pdf_path) -> str: ...
    def docx_to_pdf(self, docx_path) -> str: ...
    def pdf_to_xlsx(self, pdf_path) -> str: ...
    def xlsx_to_pdf(self, xlsx_path) -> str: ...
    def pdf_to_pptx(self, pdf_path) -> str: ...
    def pptx_to_pdf(self, pptx_path) -> str: ...
    def pdf_to_images(self, pdf_path, fmt="png", dpi=200) -> list[str]: ...
    def images_to_pdf(self, images: list[str]) -> str: ...
    def pdf_to_txt(self, pdf_path) -> str: ...
    def split_pdf(self, pdf_path, ranges: str) -> list[str]: ...
    def compress_pdf(self, pdf_path, level="normal") -> str: ...
    def extract_text_to_pdf(self, pdf_path) -> str: ...
```

**Implementação sugerida (Replit-friendly):**

* **PyMuPDF (fitz)**: render (PDF→PNG/JPG), extração `get_text("text")`, split/merge.
* **pikepdf**: compressão (`optimize_streams=True`), remover metadados, downscale de imagens quando necessário.
* **LibreOffice headless** (`soffice --headless --convert-to`): máxima fidelidade para Office ↔ PDF.
* **Pillow**: ICO/PNG/JPEG, criação de ICO multisize.
* **pdfminer.six**: fallback de texto; **pytesseract** como fallback OCR (opt-in).

### 3) API e jobs assíncronos

* **Endpoints** (montar em `app/routers/tools.py`, já incluído no `main.py`):&#x20;

  * `POST /api/convert` (multipart): `operation`, `target`, `options`, `files[]` → retorna `{job_id}`
  * `GET /api/jobs/{job_id}` → `{status, progress, results}`
  * `GET /api/jobs/{job_id}/download/{i}` → arquivo gerado
* **BackgroundTasks** para cada job, com **registry in-memory** + persistência opcional (tabela `jobs`) e **locks** por arquivo.
* **Quotas e rate limit**: honrar middlewares existentes e limites por plano (free/pro) antes de enfileirar jobs.&#x20;

### 4) UX/UI (usar a base pronta e manter coesão visual)

* **Base** já fornece nav, footer, botões, cards, e classes utilitárias. Use componentes e estilos definidos em `base.html` (e.g., `.btn`, `.modern-card`) para todas as telas de ferramentas para consistência.&#x20;
* **Dashboard**: manter blocos de uso/limites e CTAs de upgrade; garantir que `usage_summary` é preenchido pela view.&#x20;
* **Home/Index**: as chamadas para ferramentas já existem; a partir delas, a página `/tools` deve listar também conversões Office↔PDF e PDF↔Imagens/ICO.&#x20;
* **Acessibilidade**: contrastes AA, foco visível, labels (`form-label`/`form-input`) e mensagens padronizadas (`flash-*`) já previstos.&#x20;

### 5) Segurança e robustez

* **CSRF obrigatório** em `POST`/HTMX (o meta e o hook já estão no layout).&#x20;
* **TrustedHost** ligado em prod e **CORS** estrito (`allow_origins=[settings.DOMAIN]`).&#x20;
* **Sanitize** de nomes/paths, validação de MIME real (magic), bloqueio de PDFs com JavaScript incorporado.
* **Timeout** e `kill` de processos `soffice` travados.
* **Erros**: `{code, message, details}`; mensagens também como **flash** na UI (já previsto no layout).&#x20;

### 6) Deploy no Replit (Nix + deps)

* `replit.nix`: `python311`, `libreoffice`, `poppler`, `ghostscript`, `imagemagick`, `icoutils`.
* `requirements.txt`: `fastapi`, `uvicorn`, `python-multipart`, `pydantic-settings`, `sqlalchemy`, `PyMuPDF`, `pikepdf`, `Pillow`, `pdfminer.six`, `python-docx`, `python-pptx`, `openpyxl`, `passlib[bcrypt]`, `itsdangerous`, `python-dateutil`.
* Limitar tamanho de upload e paralelismo por usuário (além do middleware de rate).

### 7) Testes

* **Unit** para cada método do `ConversionService` com amostras pequenas.
* **E2E**: subir app → `POST /api/convert` → `GET /api/jobs/{id}` → download, cobrindo erros (arquivo inválido, quota estourada, extensão não suportada).

---

## PATCHES ESPECÍFICOS NOS ARQUIVOS ATUAIS

1. **main.py**

* Descomentar `CSRFMiddleware` e validar fluxo de token; manter `cleanup_temp_files()` e `periodic_cleanup()`; em prod, fixar `allow_origins` e `TrustedHost`.&#x20;

2. **base.html**

* Manter **Tailwind/HTMX/Alpine/Lucide** como está; usar classes `.btn`, `.modern-card`, `.flash-*`, `.footer-link` em todas as novas telas; o `<meta name="csrf-token">` e script HTMX já estão corretos.&#x20;

3. **contact.html**

* Trocar `data-feather` por `data-lucide` nos ícones para compatibilidade com o layout atual.&#x20;

4. **index.html & dashboard.html**

* Garantir preenchimento de `usage_summary` (plan/limits/used) vindo do backend; manter CTAs e barras de progresso conforme layout. &#x20;

5. **about/privacy/terms**

* Confirmar chaves `t()` usadas (ex.: `about_*`, `privacy_*`, `terms_*`) e adicionar traduções faltantes.  &#x20;

---



> **Você é um desenvolvedor sênior.** Corrija e evolua o HubPDF conforme os arquivos e instruções acima.
>
> 1. Reative CSRF e reforce CORS/TrustedHost; padronize ícones em Lucide.
> 2. Implemente `app/services/conversion.py` com os métodos listados (PyMuPDF, pikepdf, LibreOffice headless, Pillow, pdfminer, OCR opcional).
> 3. Crie endpoints `POST /api/convert`, `GET /api/jobs/{id}`, `GET /api/jobs/{id}/download/{i}` com **BackgroundTasks** e registry de jobs; respeite rate/quotas/limites por plano.
> 4. Use os componentes visuais já definidos em `base.html` para telas de ferramentas; mantenha progressos, flash messages e acessibilidade.
> 5. Preserve/parametrize a limpeza de temporários e implemente timeouts/kill de `soffice`.
> 6. Adicione testes unit/e2e cobrindo conversões e erros.
> 7. Entregar o código pronto para rodar no Replit (Nix + requirements) e com logs estruturados de cada job.


