Parte 1 – Corrigir cadastro/login

Revisar routers/auth.py e formularios templates/auth/*.html:

Os POSTs de registro e login devem validar CSRF (token no form) e sempre receber {"request": request} nos TemplateResponse.

No registro, validar: email obrigatório, senha mínima (>= 8), hash com Argon2, e tratar erro de email duplicado mostrando mensagem amigável (sem stacktrace).

Conferir se o banco está acessível: usar SQLite em data/app.db (criar se não existir). Em app/database.py, criar as tabelas no startup e garantir PRAGMA journal_mode=WAL.

Garantir que JWT_SECRET está sendo lido de ENV; se faltando, mostrar alerta claro na Home e usar um placeholder apenas em dev.

Adicionar uma rota GET /healthz que retorna 200 para teste.

Parte 2 – Permitir uso sem login (1 conversão com marca d’água)
Objetivo: Usuário não logado pode fazer 1 operação por dia (qualquer ferramenta), sempre com marca d’água. A partir da 2ª operação, exigir login (mostrar CTA). Usuários logados seguem as regras Free/Pro/Business já definidas (8/dia com watermark 5–8 no Free; sem watermark no Pro/Business).

Implementação técnica:

Criar um ID de sessão anônima com cookie assinado:

Cookie: anon_id (UUID4), assinado com itsdangerous usando ANON_COOKIE_SECRET (nova ENV).

Se o cookie não existir, gerar e setar com HttpOnly, Secure, SameSite=Lax, expiração 1 dia.

Adicionar tabela/counter para anônimos sem PII:

Nova tabela anon_quota(anon_id_hash, date, ops_count) (salvar hash do anon_id, nunca o valor puro).

Atualizar um helper quotas.py para:

Se usuário logado → usar regras por plano (já existentes).

Se anônimo → permitir ops_count < 1. Se ops_count >= 1, retornar 401/upgrade e renderizar página pedindo login/cadastro.

Marca d’água obrigatória no anônimo:

Em services/watermark.py, aplicar sempre que context.user is None (ou quando is_anonymous=True).

Texto localizado via i18n (watermark_text), opacidade 0.15, diagonal, fonte simples.

UI/Fluxo:

Nas páginas de ferramenta, se anônimo: mostrar badge “Modo visitante: 1 conversão/dia com marca d’água”.

Ao completar a 1ª operação do dia, próximo submit deve levar a uma tela com: “Você já usou sua conversão diária. Crie sua conta (Grátis) para 8/dia”. Botões → /auth/register e /pricing.

Segurança e anti-abuso:

Rate limit por IP e por anon_id (ex.: 10 req/min).

Limitar tamanho de upload do anônimo a 10 MB (como Free).

Limpeza de /tmp inalterada (TTL ~30min).

Testes manuais:

Sem login: rodar 1 merge (marca d’água aplicada), 2º merge deve exigir login.

Logado Free: 1–4 sem watermark, 5–8 com watermark, 9ª bloqueia.

Pro/Business: sem watermark, limites respectivos.

Importante: manter TrustedHostMiddleware compatível com host do Replit; cookies HttpOnly, Secure, SameSite=Lax; nenhum log com PII. Se Poppler não estiver disponível para pdf2image, fazer fallback para Pillow com aviso amigável na UI.

Ao finalizar, me mostre no console eventuais erros de /auth/register se persistirem.